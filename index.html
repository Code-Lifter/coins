<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Token Board V2.1</title>
    <style>
        /* --- CSS STYLES --- */
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            touch-action: none; 
        }

        #setup-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 99999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
        }
        
        input { padding: 15px; font-size: 1.2rem; width: 80%; margin-bottom: 20px; border-radius: 8px; border: none; text-align: center; }
        button.start-btn { padding: 15px 40px; font-size: 1.2rem; background-color: #27ae60; color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* The Top Bank */
        #token-bank {
            background-color: #333;
            padding: 10px;
            display: flex; justify-content: center; gap: 15px;
            border-bottom: 2px solid #555;
            height: 80px; 
            align-items: center;
            z-index: 100; /* Bank stays above playing field */
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* The Player Area */
        #player-zone {
            flex-grow: 1; position: relative; background-color: #1a1a1a;
        }

        #total-score {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem; font-weight: bold;
            color: rgba(255, 255, 255, 0.05);
            pointer-events: none; user-select: none;
        }

        /* Trash Zone */
        #trash-zone {
            position: absolute; bottom: 20px; right: 20px;
            width: 80px; height: 80px;
            border: 2px dashed #e74c3c; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: #e74c3c; font-weight: bold; font-size: 0.9rem;
            z-index: 5; transition: background 0.2s;
        }
        #trash-zone.hovered { background-color: rgba(231, 76, 60, 0.3); color: white; }

        /* The Tokens */
        .token {
            width: 55px; height: 55px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 1.1rem; color: #fff;
            cursor: grab; user-select: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            position: relative; 
            background: linear-gradient(135deg, #555, #333);
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* Scale up slightly when dragging to show it's active */
        .token.dragging {
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            transform: scale(1.15);
            border-color: white;
            cursor: grabbing;
        }

    </style>
</head>
<body>

    <div id="setup-screen">
        <h2 style="color:#ddd;">Game Setup</h2>
        <input type="text" id="coin-values" value="1, 5, 10, 50">
        <button class="start-btn" onclick="startGame()">Start Game</button>
    </div>

    <div id="token-bank"></div>

    <div id="player-zone">
        <div id="total-score">0</div>
        <div id="trash-zone">TRASH</div>
    </div>

    <script>
        const bank = document.getElementById('token-bank');
        const trash = document.getElementById('trash-zone');
        const scoreDisplay = document.getElementById('total-score');
        const colors = ['#e67e22', '#3498db', '#9b59b6', '#2ecc71', '#f1c40f', '#e74c3c'];
        
        let currentScore = 0;
        let globalZIndex = 1000; // Keeps track of top-most item

        function startGame() {
            const input = document.getElementById('coin-values').value;
            const values = input.split(',').map(v => parseInt(v.trim())).filter(n => !isNaN(n));
            
            if (values.length === 0) { alert("Enter numbers!"); return; }

            bank.innerHTML = ''; 
            values.forEach((val, index) => {
                const btn = document.createElement('div');
                btn.className = 'token bank-token';
                btn.textContent = val;
                btn.dataset.value = val;
                btn.style.backgroundColor = colors[index % colors.length];
                // Use pointerdown to start the process
                btn.addEventListener('pointerdown', spawnToken);
                bank.appendChild(btn);
            });
            document.getElementById('setup-screen').style.display = 'none';
        }

        function spawnToken(e) {
            e.preventDefault(); 
            const original = e.target;
            const val = parseInt(original.dataset.value);

            // Clone and Setup
            const clone = original.cloneNode(true);
            clone.classList.remove('bank-token');
            clone.style.position = 'absolute';
            
            // Pop to very front immediately
            globalZIndex++;
            clone.style.zIndex = globalZIndex;
            
            // Center on finger
            const rect = original.getBoundingClientRect();
            clone.style.left = rect.left + 'px';
            clone.style.top = rect.top + 'px';
            
            document.body.appendChild(clone);
            
            // Start Dragging Logic
            dragToken(clone, e, val, true);
        }

        function dragToken(elem, startEvent, value, isNew) {
            // Visual feedback
            elem.classList.add('dragging');
            elem.setPointerCapture(startEvent.pointerId); // Glues coin to finger

            // Bring to front (in case it was an old coin)
            globalZIndex++;
            elem.style.zIndex = globalZIndex;

            const rect = elem.getBoundingClientRect();
            const shiftX = startEvent.clientX - rect.left;
            const shiftY = startEvent.clientY - rect.top;

            function onPointerMove(event) {
                let newLeft = event.clientX - shiftX;
                let newTop = event.clientY - shiftY;

                // Wall Collisions
                if (newLeft < 0) newLeft = 0;
                if (newLeft > window.innerWidth - elem.offsetWidth) newLeft = window.innerWidth - elem.offsetWidth;
                if (newTop < 0) newTop = 0;
                if (newTop > window.innerHeight - elem.offsetHeight) newTop = window.innerHeight - elem.offsetHeight;

                elem.style.left = newLeft + 'px';
                elem.style.top = newTop + 'px';

                if (isOverElement(elem, trash)) trash.classList.add('hovered');
                else trash.classList.remove('hovered');
            }

            // Listen for move
            elem.addEventListener('pointermove', onPointerMove);

            // Handle Drop
            elem.onpointerup = function(event) {
                elem.removeEventListener('pointermove', onPointerMove);
                elem.releasePointerCapture(event.pointerId);
                elem.classList.remove('dragging'); // Stop glowing
                elem.onpointerup = null; // Clean up
                trash.classList.remove('hovered');

                // 1. Check if dropped in TRASH
                if (isOverElement(elem, trash)) {
                    if (!isNew) updateScore(-value); // Only subtract if it was already counted
                    elem.remove();
                    return;
                }

                // 2. Check if dropped back in BANK (The "Stacking" Fix)
                const bankRect = bank.getBoundingClientRect();
                if (event.clientY < bankRect.bottom) {
                    // It's still in the top area, destroy it.
                    if (!isNew) updateScore(-value); // Refund points if we dragged an old one back up
                    elem.remove();
                    return;
                }

                // 3. Valid Drop
                if (isNew) {
                    updateScore(value);
                    // Now it is an "old" coin, attach listener for next time
                    elem.addEventListener('pointerdown', (e) => dragToken(elem, e, value, false));
                } else {
                    // Re-attach listener to the old coin
                    elem.addEventListener('pointerdown', (e) => dragToken(elem, e, value, false));
                }
            };
        }

        function isOverElement(token, target) {
            const r1 = token.getBoundingClientRect();
            const r2 = target.getBoundingClientRect();
            return !(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom);
        }

        function updateScore(val) {
            currentScore += val;
            scoreDisplay.textContent = currentScore;
        }
    </script>
</body>
</html>